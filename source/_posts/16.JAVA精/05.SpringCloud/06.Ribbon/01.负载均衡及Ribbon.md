#### 负载均衡以及Ribbon

- ##### Ribbon是什么？
  - Spring Cloud Ribbon 是基于Netflix Ribbon 实现的一套**客户端负载均衡的工具**。
  - 简单的说，Ribbon 是 Netflix 发布的开源项目，主要功能是提供客户端的软件负载均衡算法，将 Netflix 的中间层服务连接在一起。Ribbon 的客户端组件提供一系列完整的配置项，如：连接超时、重试等。简单的说，就是在配置文件中列出 **LoadBalancer** (简称LB：负载均衡) 后面所有的及其，Ribbon 会自动的帮助你基于某种规则 (如简单轮询，随机连接等等) 去连接这些机器。我们也容易使用 Ribbon 实现自定义的负载均衡算法！

- ##### Ribbon能干嘛？

  ![在这里插入图片描述](负载均衡实例.png)

  - LB，即负载均衡 (LoadBalancer) ，在微服务或分布式集群中经常用的一种应用。
  - **负载均衡简单的说就是将用户的请求平摊的分配到多个服务上，从而达到系统的HA (高用)。**
  - 常见的负载均衡软件有 Nginx（服务器端的负载均衡）、Lvs（类似中间商、交换机） 等等。
  - Dubbo、SpringCloud 中均给我们提供了负载均衡，**SpringCloud 的负载均衡算法可以自定义**。
  - 负载均衡简单分类：
    - 集中式LB
      - 即在服务的提供方和消费方之间使用独立的LB设施，如**Nginx(反向代理服务器)**，由该设施负责把访问请求通过某种策略转发至服务的提供方！
    - 进程式 LB
      - 将LB逻辑集成到消费方，消费方从服务注册中心获知有哪些地址可用，然后自己再从这些地址中选出一个合适的服务器。
      - **Ribbon 就属于进程式LB**，它只是一个类库，集成于消费方进程，消费方通过它来获取到服务提供方的地址！

#### 集成Ribbon

- **springcloud-consumer-dept-80**向pom.xml中添加Ribbon和Eureka依赖

  ```xml
  <!--Ribbon-->
  <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-ribbon</artifactId>
      <version>1.4.6.RELEASE</version>
  </dependency>
  <!--Eureka: Ribbon需要从Eureka服务中心获取要拿什么-->
  <!--新版的Eureka是包含Ribbon的，不需要导入，导入反而会报错500No Instance-->
  <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-eureka</artifactId>
      <version>1.4.6.RELEASE</version>
  </dependency>
  ```

- 在application.yml文件中配置Eureka

  ```yml
  # Eureka配置
  eureka:
    client:
      register-with-eureka: false # 不向 Eureka注册自己
      service-url: # 从三个注册中心中随机取一个去访问
        defaultZone: http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/
  ```

- 主启动类加上EnableEurekaClient注解，开启Eureka

  ```java
  //Ribbon 和 Eureka 整合以后，客户端可以直接调用，不用关心IP地址和端口号
  @SpringBootApplication
  @EnableEurekaClient //开启Eureka 客户端
  public class DeptConsumer_80 {
      public static void main(String[] args) {
          SpringApplication.run(DeptConsumer_80.class, args);
      }
  }
  ```

- 自定义Spring配置类：ConfigBean.java 配置负载均衡实现RestTemplate

  ```java
  @Configuration //相当于spring中的applicationContext.xml
  public class ConfigBean {
  
  //    注入RestTemplate
      @Bean
      @LoadBalanced //Ribbon,配置负载均衡实现ResTemplate
      public RestTemplate getRestTemplate(){
          return new RestTemplate();
      }
  }
  ```

  - 使用Ribbo需要LoadBalanced注解，这个注解有一个核心组件IRule接口，它有很多实现类，是各种负载均衡的算法，我们只要实现了它也能自己写一些负载均衡的算法

    - 配置了这个注解后，只能根据服务名访问服务，不能用IP:端口访问了，不然会报错类似No instances available for localhost

- 修改conroller：DeptConsumerController.java

  ```java
  //原来的方式访问不走注册中心，REST_URL_PREFIX是服务的地址，
  // 而Ribbon负载均衡依赖于注册中心，所以这里应该是通过http://+服务在注册中心的服务名来访问，不用关心Ip地址和端口号
  //private static final String REST_URL_PREFIX = "http://localhost:8001";
  private static final String REST_URL_PREFIX = "http://SPRINGCLOUD-PROVIDER-DEPT";
  ```

- 如果访问不到的话，看看地址里面有没有下划线，Ribbon负载均衡是不支持下划线的

- 通过注册中心连接的服务，关掉注册中心还能连接，但是该服务重启一下就不行了

#### 6.3 使用Ribbon实现负载均衡

流程图：

![在这里插入图片描述](ribbon流程图.png)

1.新建两个服务提供者Moudle：springcloud-provider-dept-8003、springcloud-provider-dept-8002

2.参照springcloud-provider-dept-8001 依次为另外两个Moudle添加pom.xml依赖 、resourece下的mybatis和application.yml配置，Java代码

- 把yml的server.port、spring.datasource.url、eureka.instance.instance-id修改一下，三个的spring.application.name必须一致
- 如果三个生产者模块用的数据库不一样，也要注意一下mybatis的mapper文件里的sql语句

3.启动所有服务测试(根据自身电脑配置决定启动服务的个数)，访问http://eureka7001.com:7002/查看结果

4.当请求访问到8003生产者时，消费者报错404null了，不知道为什么，待修改，还是得学学原理。







