#### 概述

- 什么是zuul?
  - Zull包含了对请求的**路由**(用来跳转的)和**过滤**两个最主要功能：
  - 其中**路由功能负责将外部请求转发到具体的微服务实例上，是实现外部访问统一入口的基础**，而过**滤器功能则负责对请求的处理过程进行干预，是实现请求校验，服务聚合等功能的基础**。Zuul和Eureka进行整合，将Zuul自身注册为Eureka服务治理下的应用，同时从Eureka中获得其他服务的消息，也即以后的访问微服务都是通过Zuul跳转后获得。![在这里插入图片描述](zuul1.png)
  - 让客户只能通过www.zi.com/xxx/xxx去访问，而不能通过ip:端口/xxx/xxx访问
  - **注意**：Zuul 服务最终还是会注册进 Eureka
  - **提供**：代理 + 路由 + 过滤 三大功能！
- Zuul 能干嘛？
  - 路由
  - 过滤
- 官方文档：https://github.com/Netflix/zuul/

#### 案例

- hosts文件加一行127.0.0.1	com.zi.com，伪装域名

- 创建spring-cloud-zuul-9527模块

- 导入pom依赖

  ```xml
  <dependencies>
      <!--        zuul-->
      <dependency>
          <groupId>org.springframework.cloud</groupId>
          <artifactId>spring-cloud-starter-zuul</artifactId>
          <version>1.4.6.RELEASE</version>
      </dependency>
      <!--        dashboard-->
      <dependency>
          <groupId>org.springframework.cloud</groupId>
          <artifactId>spring-cloud-starter-hystrix-dashboard</artifactId>
          <version>1.4.6.RELEASE</version>
      </dependency>
      <!--        hystrix-->
      <dependency>
          <groupId>org.springframework.cloud</groupId>
          <artifactId>spring-cloud-starter-hystrix</artifactId>
          <version>1.4.6.RELEASE</version>
      </dependency>
  
      <!--Ribbon-->
      <dependency>
          <groupId>org.springframework.cloud</groupId>
          <artifactId>spring-cloud-starter-ribbon</artifactId>
          <version>1.4.6.RELEASE</version>
      </dependency>
      <!--Eureka: Ribbon需要从Eureka服务中心获取要拿什么-->
      <dependency>
          <groupId>org.springframework.cloud</groupId>
          <artifactId>spring-cloud-starter-eureka</artifactId>
          <version>1.4.6.RELEASE</version>
      </dependency>
  
      <dependency>
          <groupId>com.zi</groupId>
          <artifactId>spring-cloud-api</artifactId>
          <version>1.0-SNAPSHOT</version>
      </dependency>
      <dependency>
          <groupId>org.springframework.boot</groupId>
          <artifactId>spring-boot-starter-web</artifactId>
      </dependency>
  </dependencies>
  ```

- 配置application.yml，eureka没配置注册，因为默认会注册到eureka中

  ```yml
  server:
    port: 9527
  
  spring:
    application:
      name: springcloud-zuul-gateway
  
  eureka:
    client:
      service-url:
        defaultZone: http://eureka7001:7001/eureka/,http://eureka7002:7002/eureka/,http://eureka7003:7003/eureka/
    instance:
      instance-id: zuul9527.com
      prefer-ip-address: true
  
  info:
    app.name: zi-springcloud
    version: 1.0
    
  zuul:
    routes: #路由，下面两个是键值对，mydept随便起的，serviceId和path不能写错了，这样就可以www.zi.com/mydept/dept/queryAll
      mydept.serviceId: spring-cloud-provider
      mydept.path: /mydept/**
    # 不能再使用服务名spring-cloud-provider这个路径访问了，*： 忽略,隐藏全部的服务名称~
    ignored-services: "*" #spring-cloud-provider，不可能只隐藏一个服务的服务名，所以用通配符
    # 设置公共的访问前缀，一般用不上，项目发布才要，服务前面必须加/hu才能服务，http://www.zi.com:9527/hu/mydept/dept/queryAll
    prefix: /hu
  ```

  - 如果zuul报错Forwarding error，先看看spring-cloud-provider服务名有没有写错
  - 后来的理解：
    - 加上path后，写成www.zi.com/mydept/dept/queryAll，那么nginx反向代理是不是只需要代理`/mydept/`就可以了，不用项目的每个控制器都代理了
    - 加上prefix后，写成www.zi.com:9527/hu/mydept/dept/queryAll，那么nginx反向代理是不是只需要代理`/hu/`就可以了，不用eureka的每个微服务都反向代理了

- 编写启动类

  ```java
  @SpringBootApplication
  @EnableZuulProxy //开启Zuul网关代理
  public class ZuulApplication_9527 {
      public static void main(String[] args) {
          SpringApplication.run(ZuulApplication_9527.class,args);
      }
  }
  ```

- 输入www.zi.com:9527/spring-cloud-provider/dept/query1访问，spring-cloud-provider是服务名的小写

