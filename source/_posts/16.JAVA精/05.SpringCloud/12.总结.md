# 搭建微服务架构

## SpringCloud官网

http://projects.spring.io/spring-cloud/

# 项目依赖管理

- 测试依赖
- 日志依赖
- lombok依赖
- springboot依赖
- 阿里巴巴云依赖
- springcloud依赖
- mysql依赖
- mybatis-cloud依赖
- 德鲁伊连接池依赖
- json依赖
- jwt依赖
- eureka注册中心（服务端和客户端）

```xml
<packaging>pom</packaging>
<properties>
    <maven.compiler.source>8</maven.compiler.source>
    <maven.compiler.target>8</maven.compiler.target>
    <!--        测试-->
    <junit.version>4.12</junit.version>
    <!--        boot-test-->
    <boot-test.version>2.6.4</boot-test.version>
    <!--        日志-->
    <log4j.version>1.2.17</log4j.version>
    <!--        日志测试-->
    <logback-core.version>1.2.3</logback-core.version>
    <!--        快速开发-->
    <lombok.version>1.16.18</lombok.version>
    <!--        boot版本-->
    <boot-dependencies.version>2.1.4.RELEASE</boot-dependencies.version>
    <!--        阿里巴巴云-->
    <cloud-alibaba-dependencies.version>0.2.0.RELEASE</cloud-alibaba-dependencies.version>
    <!--        mysql连接-->
    <mysql-connector.version>5.1.47</mysql-connector.version>
    <!--        spring cloud版本-->
    <cloud-dependencies.version>Greenwich.SR1</cloud-dependencies.version>
    <!--        德鲁伊连接池-->
    <druid.version>1.1.10</druid.version>
    <!--        Mybatis-plus启动器-->
    <mybatis-plus.version>3.0.5</mybatis-plus.version>

    <!--        eureka注册中心-->
    <eureka.version>1.4.6.RELEASE</eureka.version>
    <!--json-->
    <json.version>1.2.79</json.version>
    <!--jwt-->
    <jwt.version>0.9.0</jwt.version>
</properties>

<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-alibaba-dependencies</artifactId>
            <version>${cloud-alibaba-dependencies.version}</version>
            <!--只用于依赖管理-->
            <type>pom</type>
            <!--只在导包时生效-->
            <scope>import</scope>
        </dependency>
        <!--springCloud的依赖-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>${cloud-dependencies.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
        <!--SpringBoot-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-dependencies</artifactId>
            <version>${boot-dependencies.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
        <!--数据库-->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>${mysql-connector.version}</version>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid</artifactId>
            <version>${druid.version}</version>
        </dependency>
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>${mybatis-plus.version}</version>
        </dependency>
        <!--日志测试~-->
        <dependency>
            <groupId>ch.qos.logback</groupId>
            <artifactId>logback-core</artifactId>
            <version>${logback-core.version}</version>
        </dependency>
        <!--            日志-->
        <dependency>
            <groupId>log4j</groupId>
            <artifactId>log4j</artifactId>
            <version>${log4j.version}</version>
        </dependency>
        <!--            快速开发-->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <version>${lombok.version}</version>
        </dependency>

        <!--            eureka server-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-eureka-server</artifactId>
            <version>${eureka.version}</version>
        </dependency>
        <!--            eureka starter-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-eureka</artifactId>
            <version>${eureka.version}</version>
        </dependency>
        <!--     负载均衡-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-ribbon</artifactId>
            <version>${eureka.version}</version>
        </dependency>

        <!--            测试-->
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>${junit.version}</version>
        </dependency>
        <!--            boot-test-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-test</artifactId>
            <version>${boot-test.version}</version>
        </dependency>

        <!--JSON-->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
            <version>${json.version}</version>
        </dependency>

        <!--jwt依赖-->
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt</artifactId>
            <version>${jwt.version}</version>
        </dependency>
    </dependencies>
</dependencyManagement>
```

# eureka服务端-注册中心

## eureka服务端-注册中心依赖

- 受项目依赖管理，控制版本
- eureka服务端

```xml
<dependencies>
    <!--导入Eureka Server依赖-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-eureka-server</artifactId>
    </dependency>
    <!--热部署工具-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-devtools</artifactId>
    </dependency>
</dependencies>
```

## eureka服务端-注册中心yml

```yml
#端口
server:
  port: 7001

#eureka
eureka:
  instance:
    #eureka服务IP
    hostname: eureka7001.com
  client:
    #是否在eureka注册
    register-with-eureka: false
    #是否被注册中心获取
    fetch-registry: false
    service-url:
      #注册到哪里
      #单机
      #defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/
      #伪集群
      defaultZone: http://eureka7002:7002/eureka/,http://eureka7003:7003/eureka/
```

## eureka服务端-注册中心启动类

```java
@SpringBootApplication
//开启eureka注册中心服务，访问http://localhost:7001
@EnableEurekaServer
public class BarterEureka7001Application {

    public static void main(String[] args) {
        SpringApplication.run(BarterEureka7001Application.class, args);
    }

}
```

# api模块

## api模块依赖

```xml

<dependencies>
    <!-- https://mvnrepository.com/artifact/io.springfox/springfox-swagger2 -->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger2</artifactId>
        <version>2.7.0</version>
    </dependency>


    <!-- https://mvnrepository.com/artifact/io.springfox/springfox-swagger-ui -->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger-ui</artifactId>
        <version>2.7.0</version>
    </dependency>

    <dependency>
        <groupId>org.example</groupId>
        <artifactId>barter</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
    </dependency>
    <!--web-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-commons</artifactId>
    </dependency>
    <!--Ribbon-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-ribbon</artifactId>
    </dependency>
    <!--导入Hystrix依赖-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-hystrix</artifactId>
        <version>1.4.6.RELEASE</version>
    </dependency>
    <!--JSON-->
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>fastjson</artifactId>
    </dependency>

    <!--redis-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-redis</artifactId>
    </dependency>

    <!--日志-->
    <dependency>
        <groupId>ch.qos.logback</groupId>
        <artifactId>logback-core</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-test</artifactId>
    </dependency>
    <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
    </dependency>
    <!--mybatis-plus-->
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-boot-starter</artifactId>
    </dependency>
    <!--mysql-->
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
    </dependency>
    <!--德鲁伊连接池-->
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>druid</artifactId>
    </dependency>
    <!--测试-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-test</artifactId>
    </dependency>
    <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
    </dependency>
    <!--Eureka依赖-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-eureka</artifactId>
    </dependency>

    <!--jwt依赖-->
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt</artifactId>
    </dependency>
</dependencies>
```

## api模块yml

```yml
mybatis-plus:
  mapper-locations: classpath:mapper/*.xml
  configuration:
  	#数据库映射实体类，下划线转驼峰
    map-underscore-to-camel-case: true
    
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/xxx?useSSL=false&useUnicode=true&characterEncoding=utf-8&serverTimezone=GMT%2b8
    #数据源
    type: com.alibaba.druid.pool.DruidDataSource
    #启动器
    driver-class-name: org.gjt.mm.mysql.Driver
    username: root
    password: root
  redis: #redis
    host: 120.77.96.250 #主机
    port: 6379 #端口
    password: 17870033452 #密码
    
#Eureka配置
eureka:
  client:
    service-url:
      #随机注册到一个注册中心
      defaultZone: http://eureka7001:7001/eureka/,http://eureka7002:7002/eureka/,http://eureka7003:7003/eureka/
```

# eureka客户端-生产者

## eureka客户端-生产者依赖

```xml
<dependencies>
    <!--api-->
    <dependency>
        <groupId>com.hzc</groupId>
        <artifactId>api</artifactId>
        <version>0.0.1-SNAPSHOT</version>
    </dependency>
</dependencies>
```

## eureka客户端-生产者yml

```yml
server:
  port: 8003

spring:
  application:
  	#服务名称，注册中心名称将是这个的全大写
    name: barter-user
  profiles:
  	#导入api模块的yml，一些重复配置可以放在api模块，去冗余，前提是api模块有对应依赖
    include: api

#Eureka配置
eureka:
  instance:
    #可以修改eureka监控中心Instances currently registered with Eureka面板的Status默认描述信息
    instance-id: barter-user
```

## eureka客户端-生产者启动类

```java
@SpringBootApplication
//注册到eureka
@EnableEurekaClient
public class BarterUserApplication {

    public static void main(String[] args) {
        SpringApplication.run(BarterUserApplication.class, args);
    }

}
```

# eureka客户端-消费者

## eureka客户端-消费者依赖

```xml
<dependencies>
    <dependency>
        <groupId>com.zi</groupId>
        <artifactId>api</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <!--Feign的依赖-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-feign</artifactId>
        <version>1.4.6.RELEASE</version>
    </dependency>
</dependencies>
```

## eureka客户端-消费者yml

```yml
server:
  port: 80

#Eureka配置
eureka:
  client:
    register-with-eureka: false #客户端不用向Eureka中注册自己
    service-url:
      defaultZone: http://eureka7001:7001/eureka/,http://eureka7002:7002/eureka/,http://eureka7003:7003/eureka/

#降级
feign:
  hystrix:
    enabled: true #开启降级
```

## eureka客户端-消费者Ribbon负载均衡

### config类

- Feign好像不需要这个配置类了
- 定义负载均衡算法看细致的笔记

```java
@Configuration
public class ConfigBean {

//    注入RestTemplate
    @Bean
    @LoadBalanced //Ribbon,配置负载均衡实现ResTemplate
    public RestTemplate getRestTemplate(){
        return new RestTemplate();
    }
}
```

## eureka客户端-消费者启动类

```java
@SpringBootApplication
@EnableEurekaClient
// 扫描带@FeignClient的接口，因为Feign的sevice接口一般放在api模块中，因为消费者模块导入了api模块，所以能够扫描到
@EnableFeignClients(basePackages = {"com.zi.springcloud"})
// 扫描带@Component的接口，如果api的层级跟消费者模块一样的话可以省略这个注解
@ComponentScan("com.zi.springcloud") 
public class DeptConsumer_80 {
    public static void main(String[] args) {
        SpringApplication.run(DeptConsumer_80.class, args);
    }
}
```

## Feign的sevice接口

```java
@Component
//name属性是服务名称，fallbackFactory属性是降级策略
@FeignClient(name = "SPRING-CLOUD-PROVIDER", fallbackFactory = DeptClientServiceCallbackFactory.class)
public interface DeptClientService {
    //这时生产者的接口
    @GetMapping("/dept/query{id}")
    Dept queryById(@PathVariable("id") Long id);

    @GetMapping("/dept/queryAll")
    List<Dept> queryAll();

    @GetMapping("/dept/add")
    boolean add(Dept dept);
}
```

## Feign的controller控制器

```java
@RestController
public class DeptConsumerController {

    @Autowired
    DeptClientService service;

    @HystrixCommand(fallbackMethod = "hystrixGet")//熔断，当当前方法抛出RuntimeException异常后，会调用备选方法
    //消费者的接口调用生产者的接口
    @RequestMapping("/consumer/get{id}")
    public Dept get(@PathVariable("id") Long id){
        return service.queryById(id);
    }
    //备选方案
    public Dept hystrixGet(@PathVariable("id")Long id){
        return new Dept()
                .setDeptno(id)
                .setDname("id=>"+id+"信息无法找到")
                .setDb_source("no this database in MYSQL");
    }
    
    @RequestMapping("/consumer/add")
    public Boolean add(Dept dept){
        return service.add(dept);
    }
    @RequestMapping("/consumer/getAll")
    public List<Dept> getAll(){
        return service.queryAll();
    }
}
```

## Hystrix降级策略

```java
//降级
@Component
public class DeptClientServiceCallbackFactory implements FallbackFactory {

    //    如果服务降级了，就不会调用正常的DeptClientService接口的方法，而是调用自定义重写的接口的方法
    @Override
    public DeptClientService create(Throwable throwable) {
        //重写接口，当服务降级之后，访问的接口方法会变成这里的对应方法
        return new DeptClientService() {
            @Override
            public Dept queryById(Long id) {
                return new Dept().setDeptno(id)
                    .setDname("这个id没有对应的信息，该服务已关闭，客户端提供了降级信息")
                    .setDb_source("No Data");
            }

            @Override
            public List<Dept> queryAll() {
                ArrayList<Dept> depts = new ArrayList<>();
                depts.add(new Dept().setDeptno(new Long(-1))
                          .setDname("这个id没有对应的信息，该服务已关闭，客户端提供了降级信息")
                          .setDb_source("No Data"));
                return depts;
            }

            @Override
            public boolean add(Dept dept) {
                return false;
            }
        };
    }
}
```

# Dashboard监控模块

## Dashboard监控依赖

```xml
<dependencies>
    <!--        dashboard-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-hystrix-dashboard</artifactId>
        <version>1.4.6.RELEASE</version>
    </dependency>
    <!--        hystrix-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-hystrix</artifactId>
        <version>1.4.6.RELEASE</version>
    </dependency>

    <!--Ribbon-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-ribbon</artifactId>
        <version>1.4.6.RELEASE</version>
    </dependency>
    <!--Eureka: Ribbon需要从Eureka服务中心获取要拿什么-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-eureka</artifactId>
        <version>1.4.6.RELEASE</version>
    </dependency>

    <!--<dependency>
        <groupId>com.zi</groupId>
        <artifactId>spring-cloud-api</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
</dependencies>
```

## Dashboard监控yml

配个端口

## Dashboard监控启动器

```java
@SpringBootApplication
@EnableHystrixDashboard  //开启Hystrix Dashboard
public class HystrixDashboardApplication {

    public static void main(String[] args) {
        SpringApplication.run(HystrixDashboardApplication.class, args);
    }
}
```

- 给spring-provider-dept-hystrix-8001模块下的主启动类添加如下代码,添加监控，模块必须要有hystrix依赖

  ```java
  //启动类
  @SpringBootApplication
  @EnableEurekaClient //它会在服务启动后自动注册到eureka
  @EnableDiscoveryClient //服务发现
  @EnableCircuitBreaker //添加对熔断的支持
  public class DeptProviderHystrix_8001 {
      public static void main(String[] args) {
          SpringApplication.run(DeptProviderHystrix_8001.class,args);
      }
  
      //    增加一个servlet
      //原来写在这里也会扫描到啊
      //SpringBootApplication注解中有SpringBootConfiguration注解，SpringBootConfiguration注解中有Configuration注解，所以这里写bean也能被扫描到
      @Bean
      public ServletRegistrationBean hystrixMetricsStreamServlet(){
          ServletRegistrationBean registrationBean = new ServletRegistrationBean(new HystrixMetricsStreamServlet());
          registrationBean.addUrlMappings("/actuator/hystrix.stream");
          return registrationBean;
      }
  }
  ```

- 访问：http://localhost:9001/hystrix

  ![在这里插入图片描述](08.Hystrix/hystrix8.png)

# Zuul网关模块

## Zuul网关依赖

```xml
<dependencies>
    <!--        zuul-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-zuul</artifactId>
        <version>1.4.6.RELEASE</version>
    </dependency>
    <!--        dashboard-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-hystrix-dashboard</artifactId>
        <version>1.4.6.RELEASE</version>
    </dependency>
    <!--        hystrix-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-hystrix</artifactId>
        <version>1.4.6.RELEASE</version>
    </dependency>

    <!--Ribbon-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-ribbon</artifactId>
        <version>1.4.6.RELEASE</version>
    </dependency>
    <!--Eureka: Ribbon需要从Eureka服务中心获取要拿什么-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-eureka</artifactId>
        <version>1.4.6.RELEASE</version>
    </dependency>

    <dependency>
        <groupId>com.zi</groupId>
        <artifactId>spring-cloud-api</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
</dependencies>
```

## Zuul网关yml

```yml
server:
  port: 9527

spring:
  application:
    name: springcloud-zuul-gateway

eureka:
  client:
    service-url:
      defaultZone: http://eureka7001:7001/eureka/,http://eureka7002:7002/eureka/,http://eureka7003:7003/eureka/
  instance:
    instance-id: zuul9527.com
    prefer-ip-address: true

info:
  app.name: zi-springcloud
  version: 1.0
  
#需要修改host文件，加上127.0.0.1	com.zi.com，伪装域名
zuul:
  # routes可以隐藏一个服务的服务名称
  routes: #路由，下面两个是键值对，mydept随便起的，serviceId和path不能写错了，这样就可以访问www.zi.com/mydept/dept/queryAll
    mydept.serviceId: spring-cloud-provider
    mydept.path: /mydept/**
  # 不能再使用服务名spring-cloud-provider这个路径访问了，*： 忽略,隐藏全部的服务名称~
  ignored-services: "*" #spring-cloud-provider，不可能只隐藏一个服务的服务名，所以用通配符
  # 设置公共的访问前缀，一般用不上，项目发布才要，服务前面必须加/hu才能服务，http://www.zi.com:9527/hu/mydept/dept/queryAll
  prefix: /hu
```

## Zuul网关启动类

```java
@SpringBootApplication
@EnableZuulProxy //开启Zuul网关代理
public class ZuulApplication_9527 {
    public static void main(String[] args) {
        SpringApplication.run(ZuulApplication_9527.class,args);
    }
}
```

# Config服务端模块

## Config服务端模块依赖

```xml
<dependencies>
    <!--web-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <!--config-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-config-server</artifactId>
        <version>2.1.1.RELEASE</version>
    </dependency>
    <!--eureka-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-eureka</artifactId>
        <version>1.4.6.RELEASE</version>
    </dependency>
</dependencies>
```

## Config服务端模块yml

```yml
server:
  port: 3344

spring:
  application:
    name: spring-cloud-config-server-3344
    #连接远程仓库
  cloud:
    # 通过 config-server可以连接到git，访问其中的资源以及配置~
    config:
      server:
        git:
          #仓库地址选的https，不要选ssh
          uri: https://gitee.com/hushushu/springcloud-config.git

# 不加这个配置会报Cannot execute request on any known server 这个错：连接Eureka服务端地址不对
# 或者直接注释掉eureka依赖 这里暂时用不到eureka
eureka:
  client:
    register-with-eureka: false
    fetch-registry: false
```

## Config服务端模块启动类

```java
@EnableConfigServer // 开启spring cloud config server服务
@SpringBootApplication
public class Config_server_3344 {
    public static void main(String[] args) {
        SpringApplication.run(Config_server_3344.class,args);
    }
}
```

## 修改其它服务的yml

### 生产者模块-application.yml

```yml
#Spring配置，其它配置都从github读取，比如说eureka相关、数据库相关、mybatis相关
spring:
  application:
    name: spring-cloud-config-provider #    起个名字
```

### 生产者模块-bootstrap.yml

```yml
# 系统级别的配置
spring:
  cloud:
    config:
      name: config-dept # 需要从git上读取的资源名称，不要后缀
      profile: dev #yml中的哪个环境
      label: master #分支
      uri: http://localhost:3344 #config服务端模块的地址
```

