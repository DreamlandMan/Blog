#### 分布式系统面临的问题

复杂分布式体系结构中的应用程序有数十个依赖关系，每个依赖关系在某些时候将不可避免失败！

#### 服务雪崩

- 多个微服务之间调用的时候，假设微服务A调用微服务B和微服务C，微服务B和微服务C又调用其他的微服务，这就是所谓的“扇出”，如果扇出的链路上**某个微服务的调用响应时间过长，或者不可用**，对微服务A的调用就会占用越来越多的系统资源，进而引起系统崩溃，所谓的“雪崩效应”。
- ![在这里插入图片描述](Hystrix1.png)
- 对于高流量的应用来说，单一的后端依赖可能会导致所有服务器上的所有资源都在几十秒内饱和。比失败更糟糕的是，这些应用程序还可能导致服务之间的延迟增加，备份队列，线程和其他系统资源紧张，导致整个系统发生更多的级联故障，**这些都表示需要对故障和延迟进行隔离和管理，以达到单个依赖关系的失败而不影响整个应用程序或系统运行**。
- 我们需要，**弃车保帅**！

#### 什么是Hystrix？

- **Hystrix**是一个应用于处理分布式系统的延迟和容错的开源库，在分布式系统里，许多依赖不可避免的会调用失败，比如超时，异常等，**Hystrix** 能够保证在一个依赖出问题的情况下，不会导致整个体系服务失败，避免级联故障，以提高分布式系统的弹性。
- “**断路器**”本身是一种开关装置，当某个服务单元发生故障之后，通过断路器的故障监控 (类似熔断保险丝) ，**向调用方返回一个服务预期的，可处理的备选响应 (FallBack) ，而不是长时间的等待或者抛出调用方法无法处理的异常，这样就可以保证了服务调用方的线程不会被长时间，不必要的占用**，从而避免了故障在分布式系统中的蔓延，乃至雪崩。

![在这里插入图片描述](Hystrix2.png)

#### Hystrix能干嘛？

- 服务降级
- 服务熔断
- 服务限流
- 接近实时的监控
- …

- 当一切正常时，请求流可以如下所示：

![format_png 2](Hystrix3.png)

- 当许多后端系统中有一个潜在阻塞服务时，它可以阻止整个用户请求：

![format_png 3](Hystrix4.png)

- 随着大容量通信量的增加，单个后端依赖项的潜在性会导致所有服务器上的所有资源在几秒钟内饱和。
- 应用程序中通过网络或客户端库可能导致网络请求的每个点都是潜在故障的来源。比失败更糟糕的是，这些应用程序还可能导致服务之间的延迟增加，从而备份队列、线程和其他系统资源，从而导致更多跨系统的级联故障。

![format_png 4](Hystrix5.png)

- 当使用**Hystrix**包装每个基础依赖项时，上面的图表中所示的体系结构会发生类似于以下关系图的变化。**每个依赖项是相互隔离的**，限制在延迟发生时它可以填充的资源中，并包含在回退逻辑中，该逻辑决定在依赖项中发生任何类型的故障时要做出什么样的响应：

![在这里插入图片描述](Hystrix6.png)

- **官网资料**：https://github.com/Netflix/Hystrix/wiki

#### 服务熔断

- #### 什么是服务熔断?

- **熔断机制是对雪崩效应的一种微服务链路保护机制**。

- 当扇出链路的某个微服务不可用或者响应时间太长时，会进行服务的降级，**进而熔断该节点微服务的调用，快速返回错误的响应信息**。检测到该节点微服务调用响应正常后恢复调用链路。在SpringCloud框架里熔断机制通过Hystrix实现。Hystrix会监控微服务间调用的状况，当失败的调用到一定阀值缺省是**5秒内20次调用失败，就会启动熔断机制**。熔断机制的注解是：**@HystrixCommand**。

- 服务熔断解决如下问题：
  - 当所依赖的对象不稳定时，能够起到快速失败的目的；
  - 快速失败后，能够根据一定的算法动态试探所依赖对象是否恢复。

##### 入门案例

- 新建springcloud-provider-dept-hystrix-8001模块并拷贝springcloud-provider-dept–8001内的**pom.xml、resource**和Java代码进行初始化并调整。

- **导入hystrix依赖**

  ```xml
  <!--导入Hystrix依赖-->
  <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-hystrix</artifactId>
      <version>1.4.6.RELEASE</version>
  </dependency>
  ```

- **调整yml配置文件**，改一下服务描述信息

  ```yml
  server:
    port: 8001
  # mybatis配置
  mybatis:
    # springcloud-api 模块下的pojo包
    type-aliases-package: com.haust.springcloud.pojo
    # 本模块下的mybatis-config.xml核心配置文件类路径
    config-location: classpath:mybatis/mybatis-config.xml
    # 本模块下的mapper配置文件类路径
    mapper-locations: classpath:mybatis/mapper/*.xml
  # spring配置
  spring:
    application:
      #项目名
      name: springcloud-provider-dept
    datasource:
      # 德鲁伊数据源
      type: com.alibaba.druid.pool.DruidDataSource
      #driver-class-name: org.gjt.mm.mysql.Driver
      driver-class-name: com.mysql.jdbc.Driver
      url: jdbc:mysql://localhost:3306/db01?useUnicode=true&characterEncoding=utf-8
      username: root
      password: root
  # Eureka配置：配置服务注册中心地址
  eureka:
    client:
      service-url:
        # 注册中心地址7001-7003
        defaultZone: http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/
    instance:
      instance-id: springcloud-provider-dept-hystrix-8001 #修改Eureka上的默认描述信息
      prefer-ip-address: true #改为true后默认显示的是ip地址而不再是localhost，这个配置没啥具体的意义
  #info配置
  info:
    app.name: haust-springcloud #项目的名称
    company.name: com.haust #公司的名称
  ```

- 修改Controller

  ```java
  @RestController
  public class DeptController {
      @Autowired
      private DeptInterface service;
  
      @HystrixCommand(fallbackMethod = "hystrixGet")//当当前方法抛出RuntimeException异常后，会调用备选方法
      @GetMapping("/dept/get{id}")
      public Dept get(@PathVariable("id") Long id){
          Dept dept = service.queryById(id);
          if (dept==null){
              throw new RuntimeException("id=>"+id+"不存在，或者信息无法找到");
          }
          return dept;
      }
  
      //备选方案
      public Dept hystrixGet(@PathVariable("id")Long id){
          return new Dept()
                  .setDeptno(id)
                  .setDname("id=>"+id+"信息无法找到")
                  .setDb_source("no this database in MYSQL");
      }
  }
  ```

- 启动器开启对断路器的支持

  ```java
  //启动类
  @SpringBootApplication
  @EnableEurekaClient //它会在服务启动后自动注册到eureka
  @EnableDiscoveryClient //服务发现
  @EnableCircuitBreaker //添加对熔断的支持
  public class DeptProviderHystrix_8001 {
      public static void main(String[] args) {
          SpringApplication.run(DeptProviderHystrix_8001.class,args);
      }
  }
  ```

  

