## 什么是 JWT？

JSON Web Token，通过数字签名的方式，以 JSON 对象为载体，在不同的服务终端之间安全的传输信息。

## JWT 有什么用？

JWT 最常见的场景就是授权认证，一旦用户登录，后续每个请求都将包含JWT，系统在每次处理用户请求的之前，都要先进行 JWT 安全校验，通过之后再进行处理。

## JWT 的组成

### JWT 由 3 部分组成，用.拼接

```java
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6IlRvbSIsInJvbGUiOiJhZG1pbiIsInN1YiI6ImFkbWluLXRlc3QiLCJleHAiOjE2MjMyMjM2NzUsImp0aSI6ImQ2MTJjZjcxLWI5ZmUtNGMwNy04MzQwLTViOWViZmMyNjExNyJ9.FOS9Y7rYNdc2AOidnSPrgg2XTYePU0yGZ598h2gtabE
```

#### 这三部分分别是：

- Header

  ```java
  {
    'typ': 'JWT',
    'alg': 'HS256'
  }
  ```

- Payload

  ```java
  {
      "sub": '1234567890',
      "name": 'john',
      "admin":true
  }
  ```

- Signature


```javascript
var encodedString = base64UrlEncode(header) + '.' + base64UrlEncode(payload);

var signature = HMACSHA256(encodedString, 'secret');
```



## SpringBoot整合

### pom.xml

```xml
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt</artifactId>
    <version>0.9.1</version>
</dependency>

<!-- JDK8以上需要加入以下四个依赖，jdk8不需要加 -->
<dependency>
    <groupId>javax.xml.bind</groupId>
    <artifactId>jaxb-api</artifactId>
    <version>2.3.0</version>
</dependency>
<dependency>
    <groupId>com.sun.xml.bind</groupId>
    <artifactId>jaxb-impl</artifactId>
    <version>2.3.0</version>
</dependency>
<dependency>
    <groupId>com.sun.xml.bind</groupId>
    <artifactId>jaxb-core</artifactId>
    <version>2.3.0</version>
</dependency>
<dependency>
    <groupId>javax.activation</groupId>
    <artifactId>activation</artifactId>
    <version>1.1.1</version>
</dependency>
```

### 代码

#### 加密

- JwtBuilder对象创建token
- token由三部分组成，Header头部分，Payload载荷部分，Signature签名部分，将三者拼接

```java
import io.jsonwebtoken.JwtBuilder;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

import java.util.Date;
import java.util.UUID;

@SpringBootTest
class DemoApplicationTests {
    //一天的毫秒数
    private long dayMillis = 1000*60*60*24;
    //签名密钥
    //过短会报错secret key byte array cannot be null or empty.
    private String signature = "admin";
    @Test
    void jwt() {
        JwtBuilder jwtBuilder = Jwts.builder();
        String jwtToken = jwtBuilder
                //jwt的id
                .setId(UUID.randomUUID().toString())
                //签名
                .setSubject("admin-test")
                //有效时间，到何时到期，现在的毫秒数加上一天的毫秒数
                .setExpiration(new Date(System.currentTimeMillis()+dayMillis))
                //头部分
                .setHeaderParam("typ","JWT")
                .setHeaderParam("alg","HS256")
                //载荷部分
                .claim("username","张三")
                .claim("role","admin")
                //签名，signature，以指定密钥用ES256编码对签名加密
                .signWith(SignatureAlgorithm.HS256,signature)
                //将jwt三部分拼接
                .compact();
        System.out.println(jwtToken);
    }
}

/*
运行结果
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODAzNjJiOC0zOGY4LTQ2NTYtOTYzYy01MGJmMzdkOWRmMGIiLCJzdWIiOiJhZG1pbi10ZXN0IiwiZXhwIjoxNjUxODIxNjE4LCJ1c2VybmFtZSI6IuW8oOS4iSIsInJvbGUiOiJhZG1pbiJ9.X8EEp-sDDp6NG2ifeRajGCOqzqwZ98wfSunBF5HiQII
*/
```

#### 解密

```java
//签名密钥
private String signature = "admin";
@Test
public void parse(){
    String token = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODAzNjJiOC0zOGY4LTQ2NTYtOTYzYy01MGJmMzdkOWRmMGIiLCJzdWIiOiJhZG1pbi10ZXN0IiwiZXhwIjoxNjUxODIxNjE4LCJ1c2VybmFtZSI6IuW8oOS4iSIsInJvbGUiOiJhZG1pbiJ9.X8EEp-sDDp6NG2ifeRajGCOqzqwZ98wfSunBF5HiQII";
    
    JwtParser jwtParser = Jwts.parser();
    Jws<Claims> claimsJws = jwtParser
        //指定解密密钥，不需要设置解密编码，因为header中的alg指定了
        .setSigningKey(signature)
        //取出token的数据，它会返回一个类似集合的对象，注意是parseClaimsJws，不是parseClaimsJwt
        .parseClaimsJws(token);
    //获取token数据
    Claims body = claimsJws.getBody();
    //打印载荷部分username的值
    System.out.println(body.get("username"));
    //打印token的ID
    System.out.println(body.getId());
    //打印签名
    System.out.println(body.getSubject());
    //打印有效期
    System.out.println(body.getExpiration());
}
/*
运行结果
张三
880362b8-38f8-4656-963c-50bf37d9df0b
admin-test
Fri May 06 15:20:18 CST 2022
*/
```

