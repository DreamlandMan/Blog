## Redis主从复制

#### 概念

-  主从复制，是指将一台Redis服务器的数据，复制到其他的Redis服务器。前者称为**主节点（Master/Leader）**,后者称为**从节点（Slave/Follower）**， 数据的复制是**单向**的！只能由**主节点复制到从节点**（**主节点以写为主、从节点以读为主**）。

- 默认情况下，**每台Redis服务器都是主节点**，一个主节点可以有0个或者多个从节点，但每个从节点只能有一个主节点。

#### 作用

- **数据冗余**：主从复制实现了数据的热备份，是持久化之外的一种数据冗余的方式。
- **故障恢复**：当主节点故障时，从节点可以暂时替代主节点提供服务，是一种服务冗余的方式
- **负载均衡**：在主从复制的基础上，配合**读写分离**，由主节点进行写操作，从节点进行读操作，分担服务器的负载；尤其是在多读少写的场景下，通过多个从节点分担负载，提高并发量。
- **高可用（集群）基石**：主从复制还是**哨兵和集群**能够实施的基础。

#### 为什么使用集群

- 单台服务器难以负载大量的请求
- 单台服务器故障率高，系统崩坏概率大，最少也要**一主二从**，真实项目中不可能使用单机redis
- 单台服务器内存容量有限，单台redis最大使用内存**不应该超过20G**。

#### 环境配置

- 只配置从库，不用配置主库

- **info replication**：客户端查看当前服务端的主从复制的信息，replication（复制）

  ```shell
  127.0.0.1:6379> INFO replication
  # Replication
  role:master #角色：master，主节点
  connected_slaves:0 #连接的从机数量：0
  master_replid:b8c79769d919c366e242fbc48f99841637e3dd57
  master_replid2:0000000000000000000000000000000000000000
  master_repl_offset:0
  second_repl_offset:-1
  repl_backlog_active:0
  repl_backlog_size:1048576
  repl_backlog_first_byte_offset:0
  repl_backlog_histlen:0
  ```

- 集群需要启动多个不同的redis服务，就需要多个配置文件

  ```shell
  [root@iZwz9dz9p8ei9h0gwdz6ohZ redisConfig]# cp redis.conf redis79.conf
  [root@iZwz9dz9p8ei9h0gwdz6ohZ redisConfig]# cp redis.conf redis80.conf
  [root@iZwz9dz9p8ei9h0gwdz6ohZ redisConfig]# cp redis.conf redis81.conf
  ```

- 每个配置文件需要修改：

  - 端口号：**port**，6379、6380、6381，一台机器防止端口冲突，多台机器不需要修改

  - pid文件：**pidfile**，/var/run/redis_6379.pid、/var/run/redis_6380.pid、/var/run/redis_6381.pid

  - 日志文件名：**logfile**，默认为空，集群这里就需要配置了，6379.log、6380.log、6381.log

  - rdb文件名：**dbfilename**，dump6379.rdb、dump6380.rdb、dump6381.rdb

  - 主机密码：**masterauth**，如果主机设置了requirepass密码，从机不加上这个配置masterauth xxxx，从机将无法设置成功，也可以使用**config set masterauth xxxx命令**

    ```shell
    #开启三个redis服务
    [root@iZwz9dz9p8ei9h0gwdz6ohZ bin]# redis-server redisConfig/redis79.conf 
    [root@iZwz9dz9p8ei9h0gwdz6ohZ bin]# redis-server redisConfig/redis80.conf 
    [root@iZwz9dz9p8ei9h0gwdz6ohZ bin]# redis-server redisConfig/redis81.conf 
    
    #查看三个redis服务进程信息
    [root@iZwz9dz9p8ei9h0gwdz6ohZ redisConfig]# ps -ef|grep redis
    root     20108     1  0 Mar12 ?        00:02:01 redis-server *:6379
    root     21616     1  0 16:18 ?        00:00:00 redis-server *:6380
    root     21622     1  0 16:18 ?        00:00:00 redis-server *:6381
    root     21628 21472  0 16:18 pts/0    00:00:00 grep --color=auto redis
    
    #开启三个窗口，三个客户端连接三个服务器
    #————————————————————————————————————————————————————————————————————————————————————
    #连接6379
    [root@iZwz9dz9p8ei9h0gwdz6ohZ bin]# redis-server redisConfig/redis79.conf 
    [root@iZwz9dz9p8ei9h0gwdz6ohZ bin]# redis-cli -p 6379
    127.0.0.1:6379> info replication
    # Replication
    role:master
    connected_slaves:0
    ...
    
    #————————————————————————————————————————————————————————————————————————————————————
    #连接6380
    [root@iZwz9dz9p8ei9h0gwdz6ohZ redisConfig]# redis-cli -p 6380
    127.0.0.1:6380> info replication
    # Replication
    role:master
    connected_slaves:0
    ...
    
    #————————————————————————————————————————————————————————————————————————————————————
    #连接6381
    [root@iZwz9dz9p8ei9h0gwdz6ohZ bin]# redis-server redisConfig/redis80.conf 
    [root@iZwz9dz9p8ei9h0gwdz6ohZ bin]# redis-cli -p 6381
    127.0.0.1:6381> info replication
    # Replication
    role:master
    connected_slaves:0
    ...
    
    ```

#### 一主二从配置

- 默认情况下，每台Redis服务器都是主节点；我们一般情况下只用配置从机就好了，**在从机中指定主机IP和端口**！

- 认老大！一主（79）二从（80，81）

- 使用**SLAVEOF host port命令**就可以为从机配置主机了。

  - SLAVEOF no one：变回主机

  ```shell
  #设置从机并查看信息
  127.0.0.1:6381> SLAVEOF 127.0.0.1 6379
  OK
  127.0.0.1:6381> info replication
  # Replication
  role:slave #角色：从机
  master_host:127.0.0.1 #主机IP
  master_port:6379 #主机端口
  master_link_status:up #up为与主节点连接成功，down为失败，没设置主机密码或者主机宕机就会down
  master_last_io_seconds_ago:6
  master_sync_in_progress:0
  slave_repl_offset:14
  slave_priority:100
  slave_read_only:1
  connected_slaves:0
  ...
  
  
  #——————————————————————————————————————————————
  #在主机中查看信息
  127.0.0.1:6379> info replication
  # Replication
  role:master #角色：主节点
  connected_slaves:1 #从节点的数量
  slave0:ip=127.0.0.1,port=6380,state=online,offset=112,lag=0 #从节点的信息
  master_replid:c0b08ba83ca3a6aecf3ea11781c2065e02cf8169
  master_replid2:0000000000000000000000000000000000000000
  master_repl_offset:112
  second_repl_offset:-1
  repl_backlog_active:1
  repl_backlog_size:1048576
  repl_backlog_first_byte_offset:1
  repl_backlog_histlen:112
  ```

- 我们这里的主从复制是使用**命令**搭建，是**暂时**的，重启会变回主机。**真实开发中应该在从机的配置文件中进行配置**，这样的话是**永久**的。

  ```shell
  #下面这两个配置默认是被注释掉的
  #设置主机的ip
  # replicaof <masterip> <masterport>
  
  #设置主机的密码
  # masterauth <master-password>
  ```

- **主机可读可写，从机只读不能写**，哪怕主机宕机了，主机中所有数据都会自动同步到从机

  ```shell
  #从机写操作会报错
  127.0.0.1:6380> set age 13
  (error) READONLY You can't write against a read only replica.
  ```

#### 复制原理

- Slave **启动**成功**连接**到 master 后会发送一个**sync同步命令**
- Master **接到**命令，启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令，在后台进程执行完毕之后，**master将传送**
  **整个数据文件到slave，并完成一次完全同步**(全量复制)。
- **全量复制**：而slave服务在接收到数据库文件数据后，将其存盘并加载到内存中。**从机连接时**。
- **增量复制**：Master 继续将新的所有收集到的修改命令依次传给slave，完成同步。**主机修改数据时**
- 但是只要是重新连接master，一次完全同步（全量复制）将被自动执行。从机一定能够同步到主机的数据。

#### 宕机后配置主机

- 集群配置可以**树状**（推荐）也可以**链式**，树状比如主（6379）从（6380、6381），链式比如主（6379）从（6380）、主（6380）从（6381），也就是说**6381**的客户端使用**SLAVEOF 127.0.0.1 6379命令**。虽然6380即是主节点又是从节点，但是使用info replication命令查看，发现它还是从节点。
- 默认情况下，**主机故障**后，不会出现新的主机，有两种方式可以**产生新的主机**：
  - 从机手动执行命令**slaveof no one**,这样执行以后从机会独立出来成为一个集群之外的主机，其它节点**手动**将其设为主节点（永久配置可以重启恢复）
  - 使用哨兵模式（**自动选举**）

