# （MySQL死锁）mybatis删除单个数据存在外键出错 Cannot delete or update a parent row: a foreign key constraint fails...

出现这个错误的原因是你想删除的那条数据与你的数据库中另一个表有约束关系(就是一个是主键，一个是外键)

![img](22.png)

比如说我的以上两个表，一个是学生选课表(course_student)，一个是课程表(course_rush)，约束为coursename，其中在课程表中coursename为主键，在学生选课表中course_rush为外键，当删掉课程表上的某一门课程时，这门课程如果被删除，那么在学生选课表上也需要删除与这门课有关的所有信息，如果只删一个表上的记录，就会报上面这个删除不成功的错误...

我的级联删除的写法(同时删除两个表中的相关联的记录)：

```
<delete id="deleteCourse" >
        delete 主表,从表 from 从表 left join 主表 on 主表关联键 = 从表关联键 where ...
</delete>

<delete id="deleteCourse" >
        delete course_student,course_rush from course_student left join course_rush on course_student.teacherID = course_rush.teacherID where course_student.coursename=#{coursename}  
</delete>
```

其中course_student和course_rush为数据库

这里还需要注意的是：在删除数据时需要先删除外键的数据，再删除主键的数据，所以这里的left join左边的course_student为外键的表，left join右边为course_rush为主键所在的表，如果位置相反仍会出错的



**如果上面的不成功**

就在从表的外键后面加上一个级联删除`on delete cascade`，当主表该记录删除会同步删除子表的关联数据

例如

```sql
CREATE TABLE `report` (
   `rid` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '举报记录ID',
   `activeUID` bigint(20) DEFAULT NULL COMMENT '举报者UID',
   `passiveGID` bigint(20) DEFAULT NULL COMMENT '被举报商品GID',
   PRIMARY KEY (`rid`),
   KEY `activeUID` (`activeUID`),
   KEY `passiveGID` (`passiveGID`),
   CONSTRAINT `activeUID` FOREIGN KEY (`activeUID`) REFERENCES `barter_user`.`user` (`UID`) on delete cascade,
   CONSTRAINT `passiveGID` FOREIGN KEY (`passiveGID`) REFERENCES `barter_goods`.`goods` (`GID`) on delete cascade
 ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

