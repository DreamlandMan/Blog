## Mysql 异常：Lock wait timeout exceeded; try restarting transaction

问题原因分析
字面原因理解就是锁等待时间超时了。
可能出现这种问题有以下几个场景：

1. 在同一事物内对同一条记录进行insert和update操作。
2. 分布式服务操作同一条记录。
3. 高并发。

上面这几种场景都有可能引起spring操作数据库死锁，而后抛出这个异常，Mysql数据库如采用InnoDB模式，默认参数:innodb_lock_wait_timeout设置锁等待的时间是50s，一旦数据库锁超过这个时间就会报错。

解决方案
查看mysql执行状态，看是否有执行缓慢的sql。

```
show  processlist;
```

查看当前运行所有事物，看事务表INNODB_TRX，里面是否有正在锁定的事务线程，看看ID是否在show processlist里面的sleep线程中，如果是，就证明这个sleep的线程事务一直没有commit或者rollback而是卡住了，我们需要手动kill掉就可以了

```
SELECT * FROM information_schema.INNODB_LOCK_waits
```



## 事务中，更新从表数据，然后删除主表关联的数据导致死锁

```sql
begin;
update barter_admin.report set result = 1 where rid = 1;
delete from barter_goods.goods where GID = 3;
commit;
```

报错

```
update barter_admin.report set result = 1 where rid = 1	
Error Code: 1205. Lock wait timeout exceeded; try restarting transaction	51.390 sec
```

通过`select * from information_schema.innodb_trx`查看当前数据库正在执行的语句，如果`trx_state`为`LOCK WAIT`代表这条语句锁住了，在占用系统资源，输入`kill xxx`命令杀死这条语句，xxx为该语句的`trx_mysql_thread_id`

之后再次执行事务报错，说外键约束，不能直接删除主表的数据

```
Error Code: 1451. Cannot delete or update a parent row: a foreign key constraint fails (`barter_service`.`trade`, CONSTRAINT `activeGid` FOREIGN KEY (`activeGid`) REFERENCES `barter_goods`.`goods` (`GID`))
```

先去把从表相关数据删除吧，或者临时设置外键失效

```sql
mysql> SET FOREIGN_KEY_CHECKS = 0;  # 临时设置外键失效
mysql>执行操作
mysql> SET FOREIGN_KEY_CHECKS = 1;  # 操作结束后恢复外键
```

